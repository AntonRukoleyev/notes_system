---
- hosts: all
  gather_facts: true
  vars:
    app_path: /opt/notes_system/api_service
    app_user: noteadmin
    app_group: noteadmin
    docker_compose_file: docker-compose.yml
  tasks:
    - name: "create {{ app_path }}/"
      file:
        path: "{{ app_path }}/"
        state: "directory"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: 0775
      become: yes
      become_method: sudo

    - name: "copy {{ docker_compose_file }}"
      copy:
        src: "{{ docker_compose_file }}"
        dest: "{{ app_path }}/{{ docker_compose_file }}"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: 0644
      become: yes
      become_method: sudo

    - name: "stop services"
      shell: docker-compose -f {{ app_path }}/{{ docker_compose_file }} stop

    - name: "pull images"
      shell: docker-compose -f {{ app_path }}/{{ docker_compose_file }} pull

    - name: "start services"
      shell: docker-compose -f {{ app_path }}/{{ docker_compose_file }} up -d